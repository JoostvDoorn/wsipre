
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>openslide &#8212; wsipre 0.1.1 documentation</title>
    <link rel="stylesheet" href="../_static/better.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  </head><body>
    <header id="pageheader"><h1><a href="../index.html ">
        wsipre 0.1.1 documentation
    </a></h1></header>
  <div class="related top">
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../index.html">Home</a></li>
      <li>
        <a href="index.html">Module code</a>
      </li> 
    </ul>
  </nav>
  </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for openslide</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># openslide-python - Python bindings for the OpenSlide library</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2010-2014 Carnegie Mellon University</span>
<span class="c1">#</span>
<span class="c1"># This library is free software; you can redistribute it and/or modify it</span>
<span class="c1"># under the terms of version 2.1 of the GNU Lesser General Public License</span>
<span class="c1"># as published by the Free Software Foundation.</span>
<span class="c1">#</span>
<span class="c1"># This library is distributed in the hope that it will be useful, but</span>
<span class="c1"># WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="c1"># or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public</span>
<span class="c1"># License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with this library; if not, write to the Free Software Foundation,</span>
<span class="c1"># Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;A library for reading whole-slide images.</span>

<span class="sd">This package provides Python bindings for the OpenSlide library.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>

<span class="kn">from</span> <span class="nn">openslide</span> <span class="k">import</span> <span class="n">lowlevel</span>

<span class="c1"># For the benefit of library users</span>
<span class="kn">from</span> <span class="nn">openslide.lowlevel</span> <span class="k">import</span> <span class="n">OpenSlideError</span><span class="p">,</span> <span class="n">OpenSlideUnsupportedFormatError</span>
<span class="kn">from</span> <span class="nn">openslide._version</span> <span class="k">import</span> <span class="n">__version__</span>

<span class="n">__library_version__</span> <span class="o">=</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>

<span class="n">PROPERTY_NAME_COMMENT</span>          <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.comment&#39;</span>
<span class="n">PROPERTY_NAME_VENDOR</span>           <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.vendor&#39;</span>
<span class="n">PROPERTY_NAME_QUICKHASH1</span>       <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.quickhash-1&#39;</span>
<span class="n">PROPERTY_NAME_BACKGROUND_COLOR</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.background-color&#39;</span>
<span class="n">PROPERTY_NAME_OBJECTIVE_POWER</span>  <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.objective-power&#39;</span>
<span class="n">PROPERTY_NAME_MPP_X</span>            <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.mpp-x&#39;</span>
<span class="n">PROPERTY_NAME_MPP_Y</span>            <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.mpp-y&#39;</span>
<span class="n">PROPERTY_NAME_BOUNDS_X</span>         <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.bounds-x&#39;</span>
<span class="n">PROPERTY_NAME_BOUNDS_Y</span>         <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.bounds-y&#39;</span>
<span class="n">PROPERTY_NAME_BOUNDS_WIDTH</span>     <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.bounds-width&#39;</span>
<span class="n">PROPERTY_NAME_BOUNDS_HEIGHT</span>    <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;openslide.bounds-height&#39;</span>

<span class="k">class</span> <span class="nc">AbstractSlide</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The base class of a slide object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">detect_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string describing the format of the specified file.</span>

<span class="sd">        If the file format is not recognized, return None.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the slide.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of levels in the image.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of (width, height) tuples, one for each level of the image.</span>

<span class="sd">        level_dimensions[n] contains the dimensions of level n.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A (width, height) tuple for level 0 of the image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_downsamples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of downsampling factors for each level of the image.</span>

<span class="sd">        level_downsample[n] contains the downsample factor of level n.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Metadata about the image.</span>

<span class="sd">        This is a map: property name -&gt; property value.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">associated_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Images associated with this whole-slide image.</span>

<span class="sd">        This is a map: image name -&gt; PIL.Image.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_best_level_for_downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">downsample</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the best level for displaying the given downsample.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">read_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a PIL.Image containing the contents of the region.</span>

<span class="sd">        location: (x, y) tuple giving the top left pixel in the level 0</span>
<span class="sd">                  reference frame.</span>
<span class="sd">        level:    the level number.</span>
<span class="sd">        size:     (width, height) tuple giving the region size.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a PIL.Image containing an RGB thumbnail of the image.</span>

<span class="sd">        size:     the maximum size of the thumbnail.&quot;&quot;&quot;</span>
        <span class="n">downsample</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">dim</span> <span class="o">/</span> <span class="n">thumb</span> <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">thumb</span> <span class="ow">in</span>
                <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">size</span><span class="p">)])</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_best_level_for_downsample</span><span class="p">(</span><span class="n">downsample</span><span class="p">)</span>
        <span class="n">tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_region</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="n">level</span><span class="p">])</span>
        <span class="c1"># Apply on solid background</span>
        <span class="n">bg_color</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PROPERTY_NAME_BACKGROUND_COLOR</span><span class="p">,</span>
                <span class="s1">&#39;ffffff&#39;</span><span class="p">)</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="n">tile</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">bg_color</span><span class="p">)</span>
        <span class="n">thumb</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile</span><span class="p">)</span>
        <span class="n">thumb</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thumb</span>


<span class="k">class</span> <span class="nc">OpenSlide</span><span class="p">(</span><span class="n">AbstractSlide</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An open whole-slide image.</span>

<span class="sd">    close() is called automatically when the object is deleted.</span>
<span class="sd">    The object may be used as a context manager, in which case it will be</span>
<span class="sd">    closed upon exiting the context.</span>

<span class="sd">    If an operation fails, OpenSlideError is raised.  Note that OpenSlide</span>
<span class="sd">    has latching error semantics: once OpenSlideError is raised, all future</span>
<span class="sd">    operations on the OpenSlide object, other than close(), will fail.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a whole-slide image.&quot;&quot;&quot;</span>
        <span class="n">AbstractSlide</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_osr</span> <span class="o">=</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">detect_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string describing the format vendor of the specified file.</span>

<span class="sd">        If the file format is not recognized, return None.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">detect_vendor</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the OpenSlide object.&quot;&quot;&quot;</span>
        <span class="n">lowlevel</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of levels in the image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">get_level_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of (width, height) tuples, one for each level of the image.</span>

<span class="sd">        level_dimensions[n] contains the dimensions of level n.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lowlevel</span><span class="o">.</span><span class="n">get_level_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level_count</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_downsamples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of downsampling factors for each level of the image.</span>

<span class="sd">        level_downsample[n] contains the downsample factor of level n.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lowlevel</span><span class="o">.</span><span class="n">get_level_downsample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level_count</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Metadata about the image.</span>

<span class="sd">        This is a map: property name -&gt; property value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_PropertyMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">associated_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Images associated with this whole-slide image.</span>

<span class="sd">        This is a map: image name -&gt; PIL.Image.</span>

<span class="sd">        Unlike in the C interface, the images accessible via this property</span>
<span class="sd">        are not premultiplied.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_AssociatedImageMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_best_level_for_downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">downsample</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the best level for displaying the given downsample.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">get_best_level_for_downsample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">,</span> <span class="n">downsample</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a PIL.Image containing the contents of the region.</span>

<span class="sd">        location: (x, y) tuple giving the top left pixel in the level 0</span>
<span class="sd">                  reference frame.</span>
<span class="sd">        level:    the level number.</span>
<span class="sd">        size:     (width, height) tuple giving the region size.</span>

<span class="sd">        Unlike in the C interface, the image data returned by this</span>
<span class="sd">        function is not premultiplied.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">read_region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">,</span> <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">level</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">_OpenSlideMap</span><span class="p">(</span><span class="n">Mapping</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">osr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_osr</span> <span class="o">=</span> <span class="n">osr</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Private method; always returns list.</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_PropertyMap</span><span class="p">(</span><span class="n">_OpenSlideMap</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">get_property_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">get_property_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">v</span>


<span class="k">class</span> <span class="nc">_AssociatedImageMap</span><span class="p">(</span><span class="n">_OpenSlideMap</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">get_associated_image_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lowlevel</span><span class="o">.</span><span class="n">read_associated_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osr</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ImageSlide</span><span class="p">(</span><span class="n">AbstractSlide</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper for a PIL.Image that provides the OpenSlide interface.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open an image file.</span>

<span class="sd">        file can be a filename or a PIL.Image.&quot;&quot;&quot;</span>
        <span class="n">AbstractSlide</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_arg</span> <span class="o">=</span> <span class="n">file</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_arg</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">detect_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string describing the format of the specified file.</span>

<span class="sd">        If the file format is not recognized, return None.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">format</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
                <span class="c1"># Pillow &gt;= 2.5.0</span>
                <span class="n">img</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">format</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the slide object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
                <span class="c1"># Pillow &gt;= 2.5.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of levels in the image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of (width, height) tuples, one for each level of the image.</span>

<span class="sd">        level_dimensions[n] contains the dimensions of level n.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">size</span><span class="p">,)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">level_downsamples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of downsampling factors for each level of the image.</span>

<span class="sd">        level_downsample[n] contains the downsample factor of level n.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Metadata about the image.</span>

<span class="sd">        This is a map: property name -&gt; property value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">associated_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Images associated with this whole-slide image.</span>

<span class="sd">        This is a map: image name -&gt; PIL.Image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_best_level_for_downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_downsample</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the best level for displaying the given downsample.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">read_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a PIL.Image containing the contents of the region.</span>

<span class="sd">        location: (x, y) tuple giving the top left pixel in the level 0</span>
<span class="sd">                  reference frame.</span>
<span class="sd">        level:    the level number.</span>
<span class="sd">        size:     (width, height) tuple giving the region size.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OpenSlideError</span><span class="p">(</span><span class="s2">&quot;Invalid level&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">[</span><span class="s1">&#39;fail&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">size</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">OpenSlideError</span><span class="p">(</span><span class="s2">&quot;Size </span><span class="si">%s</span><span class="s2"> must be non-negative&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">,))</span>
        <span class="c1"># Any corner of the requested region may be outside the bounds of</span>
        <span class="c1"># the image.  Create a transparent tile of the correct size and</span>
        <span class="c1"># paste the valid part of the region into the correct location.</span>
        <span class="n">image_topleft</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">limit</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="n">image_bottomright</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">limit</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="n">tile</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="s1">&#39;fail&#39;</span> <span class="k">for</span> <span class="n">tl</span><span class="p">,</span> <span class="n">br</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_topleft</span><span class="p">,</span> <span class="n">image_bottomright</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">br</span> <span class="o">-</span> <span class="n">tl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]:</span>  <span class="c1"># &quot;&lt; 0&quot; not a typo</span>
            <span class="c1"># Crop size is greater than zero in both dimensions.</span>
            <span class="c1"># PIL thinks the bottom right is the first *excluded* pixel</span>
            <span class="n">crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">image_topleft</span> <span class="o">+</span>
                    <span class="p">[</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">image_bottomright</span><span class="p">])</span>
            <span class="n">tile_offset</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">il</span> <span class="o">-</span> <span class="n">l</span> <span class="k">for</span> <span class="n">il</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">image_topleft</span><span class="p">,</span> <span class="n">location</span><span class="p">))</span>
            <span class="n">tile</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="n">tile_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tile</span>


<span class="k">def</span> <span class="nf">open_slide</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open a whole-slide or regular image.</span>

<span class="sd">    Return an OpenSlide object for whole-slide images and an ImageSlide</span>
<span class="sd">    object for other types of images.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OpenSlide</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">OpenSlideUnsupportedFormatError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ImageSlide</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenSlide vendor:&quot;</span><span class="p">,</span> <span class="n">OpenSlide</span><span class="o">.</span><span class="n">detect_format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PIL format:&quot;</span><span class="p">,</span> <span class="n">ImageSlide</span><span class="o">.</span><span class="n">detect_format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">with</span> <span class="n">open_slide</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">as</span> <span class="n">_slide</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dimensions:&quot;</span><span class="p">,</span> <span class="n">_slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Levels:&quot;</span><span class="p">,</span> <span class="n">_slide</span><span class="o">.</span><span class="n">level_count</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Level dimensions:&quot;</span><span class="p">,</span> <span class="n">_slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Level downsamples:&quot;</span><span class="p">,</span> <span class="n">_slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Properties:&quot;</span><span class="p">,</span> <span class="n">_slide</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Associated images:&quot;</span><span class="p">,</span> <span class="n">_slide</span><span class="o">.</span><span class="n">associated_images</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<form class="search" action="../search.html" method="get">
  <input type="text" name="q"
   placeholder="type to search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="related bottom">
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="../index.html">Home</a></li>
      <li>
        <a href="index.html">Module code</a>
      </li> 
    </ul>
  </nav>
  </div>
  <footer id="pagefooter">&copy; 2018, Luis A. Vale Silva.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a>
      1.8.2
        with the <a href="http://github.com/irskep/sphinx-better-theme">
          better</a> theme.

  </footer>

  
  </body>
</html>